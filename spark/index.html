<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="infinity-legend-roles" content="SPARK,ORCHESTRATOR,MEMORY_NODE,EMITTER">
<meta name="infinity-legend-symbols" content="‚ö°,üõí,ü™ê,üü°">
<title>‚ö° SPARK INDEX BUILDER</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Courier New', monospace;
  background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
  min-height: 100vh;
  color: #ffffff;
  padding: 1.5rem;
  overflow-x: hidden;
}

.container {
  max-width: 1600px;
  margin: 0 auto;
}

header {
  text-align: center;
  margin-bottom: 2rem;
  padding: 1.5rem 0;
  border-bottom: 2px solid rgba(255, 215, 0, 0.3);
}

h1 {
  font-size: 2.5rem;
  background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
  animation: shimmer 3s ease-in-out infinite;
  font-weight: bold;
}

@keyframes shimmer {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.principle {
  background: rgba(255, 215, 0, 0.1);
  padding: 1rem;
  border-radius: 8px;
  border: 2px solid #ffd700;
  margin: 1rem auto;
  max-width: 800px;
  font-size: 1.1rem;
  line-height: 1.6;
}

.principle strong {
  color: #ffd700;
}

.status-bar {
  display: flex;
  justify-content: center;
  gap: 1.5rem;
  margin: 1.5rem 0;
  flex-wrap: wrap;
}

.status-badge {
  background: rgba(255, 255, 255, 0.05);
  padding: 0.5rem 1.5rem;
  border-radius: 20px;
  border: 1px solid rgba(255, 215, 0, 0.3);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.pulse {
  width: 10px;
  height: 10px;
  background: #00ff00;
  border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}

.main-grid {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 2rem;
  margin-bottom: 2rem;
}

@media (max-width: 1024px) {
  .main-grid {
    grid-template-columns: 1fr;
  }
}

.panel {
  background: rgba(255, 255, 255, 0.05);
  padding: 1.5rem;
  border-radius: 10px;
  border: 1px solid rgba(255, 215, 0, 0.2);
}

.panel h2 {
  color: #ffd700;
  margin-bottom: 1rem;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  color: #ffd700;
  margin-bottom: 0.5rem;
  font-weight: bold;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 215, 0, 0.3);
  border-radius: 5px;
  padding: 0.75rem;
  color: #ffffff;
  font-family: 'Courier New', monospace;
  font-size: 1rem;
}

.form-group textarea {
  min-height: 150px;
  resize: vertical;
  white-space: pre-wrap;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: #ffd700;
  box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

.btn {
  background: #ffd700;
  color: #0f0c29;
  padding: 0.75rem 2rem;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-family: 'Courier New', monospace;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn:hover {
  background: #ffed4e;
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-box {
  background: rgba(255, 255, 255, 0.08);
  padding: 1rem;
  border-radius: 8px;
  border: 2px solid rgba(255, 215, 0, 0.3);
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  color: #ffd700;
  font-weight: bold;
  margin-bottom: 0.3rem;
}

.stat-label {
  font-size: 0.85rem;
  color: #cccccc;
  text-transform: uppercase;
}

.sparks-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
  max-height: 600px;
  overflow-y: auto;
  padding-right: 0.5rem;
}

.sparks-grid::-webkit-scrollbar {
  width: 8px;
}

.sparks-grid::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

.sparks-grid::-webkit-scrollbar-thumb {
  background: rgba(255, 215, 0, 0.3);
  border-radius: 4px;
}

.sparks-grid::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 215, 0, 0.5);
}

.spark-card {
  background: rgba(255, 255, 255, 0.05);
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid rgba(255, 215, 0, 0.2);
  transition: all 0.3s ease;
  cursor: pointer;
}

.spark-card:hover {
  border-color: #ffd700;
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
  transform: translateY(-3px);
}

.spark-id {
  color: #ffd700;
  font-weight: bold;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.spark-title {
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
  font-weight: bold;
}

.spark-preview {
  font-size: 0.85rem;
  color: #cccccc;
  margin-bottom: 0.5rem;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.spark-meta {
  font-size: 0.75rem;
  color: #999;
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.roles-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
  margin-top: 0.5rem;
}

.role-tag {
  background: rgba(255, 215, 0, 0.2);
  color: #ffd700;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.7rem;
}

.graph-canvas {
  width: 100%;
  height: 400px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  border: 1px solid rgba(255, 215, 0, 0.2);
}

.empty-state {
  text-align: center;
  color: #999;
  padding: 3rem;
  font-style: italic;
}

.nav-links {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-top: 2rem;
  flex-wrap: wrap;
}

.nav-link {
  background: rgba(255, 255, 255, 0.05);
  color: #ffd700;
  padding: 0.5rem 1rem;
  border-radius: 5px;
  border: 1px solid rgba(255, 215, 0, 0.3);
  text-decoration: none;
  transition: all 0.3s ease;
}

.nav-link:hover {
  border-color: #ffd700;
  box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

footer {
  text-align: center;
  margin-top: 3rem;
  padding-top: 2rem;
  border-top: 2px solid rgba(255, 215, 0, 0.3);
  color: #999;
}

@media (max-width: 768px) {
  h1 {
    font-size: 2rem;
  }
  
  .sparks-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>‚ö° SPARK INDEX BUILDER</h1>
    <div class="principle">
      <strong>‚ö° NEVER DESTROY PRINCIPLE:</strong> Every input creates a NEW page. Nothing is ever overwritten.
      All sparks are linked and discoverable. Content only GROWS, never shrinks.
    </div>
    <div class="status-bar">
      <div class="status-badge">
        <div class="pulse"></div>
        <span>ü™ê Memory Active</span>
      </div>
      <div class="status-badge">
        <div class="pulse"></div>
        <span>üß≤ü™êüîÅ Loop Running</span>
      </div>
      <div class="status-badge">
        <span id="sparkCount">0 Sparks</span>
      </div>
    </div>
  </header>

  <div class="stats-grid">
    <div class="stat-box">
      <div class="stat-value" id="totalSparks">0</div>
      <div class="stat-label">Total Sparks</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="totalConnections">0</div>
      <div class="stat-label">Connections</div>
    </div>
    <div class="stat-box">
      <div class="stat-value" id="growthRate">+0</div>
      <div class="stat-label">Today</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">‚àû</div>
      <div class="stat-label">Capacity</div>
    </div>
  </div>

  <div class="main-grid">
    <div class="panel">
      <h2>‚ö° Create New Spark</h2>
      <form id="sparkForm">
        <div class="form-group">
          <label for="sparkTitle">Title</label>
          <input type="text" id="sparkTitle" required placeholder="Enter spark title...">
        </div>
        
        <div class="form-group">
          <label for="sparkContent">Content</label>
          <textarea id="sparkContent" required placeholder="Enter spark content..."></textarea>
        </div>
        
        <div class="form-group">
          <label for="sparkRoles">Legend Roles (comma-separated)</label>
          <input type="text" id="sparkRoles" placeholder="e.g., SPARK,CREATOR,EMITTER">
        </div>
        
        <div class="form-group">
          <label for="sparkConnections">Connect to Spark IDs (comma-separated)</label>
          <input type="text" id="sparkConnections" placeholder="e.g., spark_001,spark_003">
        </div>
        
        <button type="submit" class="btn">‚ö° Emit Spark</button>
      </form>
    </div>

    <div class="panel">
      <h2>üìä Connection Graph</h2>
      <canvas id="graphCanvas" class="graph-canvas"></canvas>
      <p style="margin-top: 1rem; color: #999; font-size: 0.85rem; text-align: center;">
        Click nodes to navigate ‚Ä¢ Golden lines show connections
      </p>
    </div>
  </div>

  <div class="panel">
    <h2>‚ú® All Sparks</h2>
    <div id="sparksGrid" class="sparks-grid">
      <div class="empty-state">
        No sparks created yet. Create your first spark above! ‚ö°
      </div>
    </div>
  </div>

  <div class="nav-links">
    <a href="../index.html" class="nav-link">üëë Crown Index</a>
    <a href="../legend.json" class="nav-link">üìÑ Legend JSON</a>
    <a href="../LEGEND.md" class="nav-link">üìñ Documentation</a>
    <a href="./builder/intake.html" class="nav-link">üì• Intake Node</a>
    <a href="./builder/weaver.html" class="nav-link">ü™° Weaver</a>
    <a href="./builder/emitter.html" class="nav-link">üü° Emitter</a>
  </div>

  <footer>
    <p>‚ö° Spark Index Builder ‚Ä¢ Never Destroy ‚Ä¢ Always Build</p>
    <p style="margin-top: 0.5rem;">Part of the Infinity Legend System v1.0.0</p>
  </footer>
</div>

<script>
// localStorage key for spark system
const STORAGE_KEY = 'infinity_legend_sparks';

// Load or initialize spark state
function loadState() {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored) {
    try {
      return JSON.parse(stored);
    } catch (e) {
      console.error('Error parsing stored state:', e);
    }
  }
  return {
    sparks: [],
    connections: [],
    nextId: 1
  };
}

// Save state to localStorage
function saveState(state) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// Global state
let state = loadState();

// Update statistics
function updateStats() {
  const today = new Date().toISOString().split('T')[0];
  const todaySparks = state.sparks.filter(s => 
    s.timestamp.split('T')[0] === today
  ).length;
  
  document.getElementById('totalSparks').textContent = state.sparks.length;
  document.getElementById('sparkCount').textContent = `${state.sparks.length} Sparks`;
  document.getElementById('totalConnections').textContent = state.connections.length;
  document.getElementById('growthRate').textContent = `+${todaySparks}`;
}

// Render sparks grid
function renderSparks() {
  const grid = document.getElementById('sparksGrid');
  
  if (state.sparks.length === 0) {
    grid.innerHTML = '<div class="empty-state">No sparks created yet. Create your first spark above! ‚ö°</div>';
    return;
  }
  
  grid.innerHTML = '';
  
  // Reverse to show newest first
  [...state.sparks].reverse().forEach(spark => {
    const card = document.createElement('div');
    card.className = 'spark-card';
    card.onclick = () => viewSpark(spark.id);
    
    const rolesHtml = spark.roles.length > 0 
      ? `<div class="roles-tags">${spark.roles.map(r => `<span class="role-tag">${r}</span>`).join('')}</div>`
      : '';
    
    const connectionsText = spark.connections.length > 0
      ? `‚Ä¢ ${spark.connections.length} connection(s)`
      : '';
    
    card.innerHTML = `
      <div class="spark-id">${spark.icon} ${spark.id}</div>
      <div class="spark-title">${spark.title}</div>
      <div class="spark-preview">${spark.content}</div>
      ${rolesHtml}
      <div class="spark-meta">
        ${new Date(spark.timestamp).toLocaleString()} ${connectionsText}
      </div>
    `;
    
    grid.appendChild(card);
  });
}

// Draw connection graph
function drawGraph() {
  const canvas = document.getElementById('graphCanvas');
  const ctx = canvas.getContext('2d');
  
  // Set canvas size
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (state.sparks.length === 0) {
    ctx.fillStyle = '#666';
    ctx.font = '16px Courier New';
    ctx.textAlign = 'center';
    ctx.fillText('No sparks to visualize yet', canvas.width / 2, canvas.height / 2);
    return;
  }
  
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(canvas.width, canvas.height) * 0.35;
  
  // Calculate node positions
  const nodePositions = {};
  state.sparks.forEach((spark, index) => {
    const angle = (index / state.sparks.length) * 2 * Math.PI - Math.PI / 2;
    nodePositions[spark.id] = {
      x: centerX + radius * Math.cos(angle),
      y: centerY + radius * Math.sin(angle),
      spark: spark
    };
  });
  
  // Draw connections
  ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)';
  ctx.lineWidth = 2;
  state.connections.forEach(conn => {
    const from = nodePositions[conn.from];
    const to = nodePositions[conn.to];
    if (from && to) {
      ctx.beginPath();
      ctx.moveTo(from.x, from.y);
      ctx.lineTo(to.x, to.y);
      ctx.stroke();
    }
  });
  
  // Draw nodes
  Object.values(nodePositions).forEach(node => {
    // Node circle
    ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
    ctx.beginPath();
    ctx.arc(node.x, node.y, 8, 0, 2 * Math.PI);
    ctx.fill();
    
    // Node label
    ctx.fillStyle = '#ffd700';
    ctx.font = '12px Courier New';
    ctx.textAlign = 'center';
    ctx.fillText(node.spark.id.split('_')[1], node.x, node.y - 15);
  });
}

// View/download spark
function viewSpark(sparkId) {
  const spark = state.sparks.find(s => s.id === sparkId);
  if (!spark) return;
  
  // Generate HTML for spark page
  const html = generateSparkHTML(spark);
  
  // Create blob and download
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${spark.id}.html`;
  a.click();
  URL.revokeObjectURL(url);
  
  alert(`‚ú® Spark page generated!\n\nDownload: ${spark.id}.html\n\nSave it to: /spark/sparks/\n\nThe spark is now emitted and preserved forever! ‚ö°`);
}

// Generate HTML for a spark page
function generateSparkHTML(spark) {
  const connectedSparks = state.sparks.filter(s => 
    spark.connections.includes(s.id)
  );
  
  const connectionsHTML = connectedSparks.length > 0
    ? `
      <div class="connections">
        <h2>üîó Connected Sparks</h2>
        ${connectedSparks.map(s => `
          <div class="connection-item">
            <strong>${s.icon} ${s.id}:</strong> ${s.title}
          </div>
        `).join('')}
      </div>
    `
    : '';
  
  const rolesHTML = spark.roles.length > 0
    ? `<div class="roles">${spark.roles.map(r => `<span class="role-badge">${r}</span>`).join('')}</div>`
    : '';
  
  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="infinity-legend-roles" content="${spark.roles.join(',')}">
<meta name="spark-id" content="${spark.id}">
<meta name="spark-timestamp" content="${spark.timestamp}">
<title>${spark.icon} ${spark.title}</title>
<style>
body {
  font-family: 'Courier New', monospace;
  background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
  min-height: 100vh;
  color: #ffffff;
  padding: 2rem;
  line-height: 1.6;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.05);
  padding: 2rem;
  border-radius: 10px;
  border: 1px solid rgba(255, 215, 0, 0.3);
}
h1 {
  color: #ffd700;
  margin-bottom: 1rem;
}
.meta {
  color: #999;
  font-size: 0.9rem;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(255, 215, 0, 0.2);
}
.content {
  white-space: pre-wrap;
  background: rgba(0, 0, 0, 0.3);
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid rgba(255, 215, 0, 0.2);
  margin-bottom: 2rem;
}
.roles {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin: 1rem 0;
}
.role-badge {
  background: rgba(255, 215, 0, 0.2);
  color: #ffd700;
  padding: 0.3rem 0.8rem;
  border-radius: 5px;
  font-size: 0.85rem;
  border: 1px solid rgba(255, 215, 0, 0.3);
}
.connections {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 2px solid rgba(255, 215, 0, 0.3);
}
.connections h2 {
  color: #ffd700;
  margin-bottom: 1rem;
}
.connection-item {
  background: rgba(255, 255, 255, 0.05);
  padding: 0.8rem;
  border-radius: 5px;
  border: 1px solid rgba(255, 215, 0, 0.2);
  margin-bottom: 0.5rem;
}
.back-link {
  display: inline-block;
  margin-top: 2rem;
  padding: 0.75rem 1.5rem;
  background: rgba(255, 215, 0, 0.1);
  color: #ffd700;
  text-decoration: none;
  border-radius: 8px;
  border: 2px solid #ffd700;
  font-weight: bold;
  transition: all 0.3s ease;
}
.back-link:hover {
  background: #ffd700;
  color: #0f0c29;
  transform: translateY(-2px);
}
</style>
</head>
<body>
<div class="container">
  <h1>${spark.icon} ${spark.title}</h1>
  <div class="meta">
    <strong>Spark ID:</strong> ${spark.id}<br>
    <strong>Created:</strong> ${new Date(spark.timestamp).toLocaleString()}<br>
    <strong>Part of:</strong> Infinity Legend System v1.0.0
  </div>
  ${rolesHTML}
  <div class="content">${spark.content}</div>
  ${connectionsHTML}
  <a href="../index.html" class="back-link">‚Üê Back to Spark Index</a>
</div>
</body>
</html>`;
}

// Handle form submission
document.getElementById('sparkForm').addEventListener('submit', (e) => {
  e.preventDefault();
  
  const title = document.getElementById('sparkTitle').value.trim();
  const content = document.getElementById('sparkContent').value.trim();
  const rolesInput = document.getElementById('sparkRoles').value.trim();
  const connectionsInput = document.getElementById('sparkConnections').value.trim();
  
  // Parse roles
  const roles = rolesInput 
    ? rolesInput.split(',').map(r => r.trim()).filter(r => r)
    : [];
  
  // Parse connections
  const connections = connectionsInput
    ? connectionsInput.split(',').map(c => c.trim()).filter(c => c)
    : [];
  
  // Validate connections exist
  const validConnections = connections.filter(id => 
    state.sparks.some(s => s.id === id)
  );
  
  // Create spark
  const spark = {
    id: `spark_${String(state.nextId).padStart(3, '0')}`,
    title: title,
    content: content,
    roles: roles,
    connections: validConnections,
    timestamp: new Date().toISOString(),
    icon: '‚ö°'
  };
  
  // Add to state
  state.sparks.push(spark);
  state.nextId++;
  
  // Add connection records
  validConnections.forEach(connId => {
    state.connections.push({
      from: spark.id,
      to: connId,
      created: new Date().toISOString()
    });
  });
  
  // Save state
  saveState(state);
  
  // Update UI
  updateStats();
  renderSparks();
  drawGraph();
  
  // Reset form
  document.getElementById('sparkForm').reset();
  
  // Show success
  alert(`‚ú® Spark created: ${spark.id}\n\nClick on the spark card to download its HTML page!`);
});

// Initialize on load
updateStats();
renderSparks();
drawGraph();

// Redraw graph on window resize
window.addEventListener('resize', drawGraph);
</script>
</body>
</html>
